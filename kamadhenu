#!/usr/bin/env zsh
# Kamadhenu
# an udderly absurd soothsayer in your shell

# figure out where Kamadhenu sits
# find the executable from its symlink
KMDIR="$(dirname "$(readlink "$0")")"
introduced=
# Pick a new font and cow at random
randomize() {
    unset COW
    COW=$(ls $KMDIR/cows | shuf -n 1)
    unset FONT
    FONT=$(ls $KMDIR/figlet/fonts | shuf -n 1)
}

# Spit out fortunes based on input arg
printFortune() {
    randomize
    if [ -z $1 ]; then
        fortune -s | cowsay -f $COW | lolcat
        exit 0
    elif [ ! $introduced ] ; then
        # we havent been properly introduced
        introduced=true
        figlet -f cybermedium 'Kamadhenu' | lolcat -a
        sleep 1
        introMsg | lolcat
        sleep 1
        errorMsg | lolcat
        sleep 1
        beginMsg | lolcat
        sleep 1
        printFortune $1
    else
        arg="$1"
        # long enough to allow for most words
        # http://www.ravi.io/language-word-lengths
        if [ ${#arg} -le 14 ]; then
            # print short requests as figlet
            figlet -w $COLUMNS -f $FONT $arg | cowsay -nf $COW | lolcat
        else
        # elif [ ${#arg} -le 1024 ]; then
            # requests long enough to break the screen are refused
            echo $arg | cut -c -1024 | cowsay -f $COW | lolcat
        fi
    fi
    prompt
}

# I am the gatekeeper. Are you the keymaster?

# Ask the player for input
prompt() {
    unset INPUT
    vared -chp "$PROMPTMSG" INPUT
    printFortune $INPUT
}

# cast your lots, see what dreams may come

# Figure out what was input
# - if a number < 10, queue up random fortunes
# - if flags or options, set them
# - if a string, send to (fig/toi)let

# messages and sprites
introMsg() {
    cat << EOF
                    {}}
                   {{}{}
                  {{}}{}}
                 &>&&&&?&@
               &&@&&&@*&@#&#@
            &&&&#&*&&&&@&&&#&&&@
         &#&&@&&$&&&&&&&&&&&@&#&*&@
      &&*$&&$&7&&&$&>&&&&?&&&<&#&$&&#@
  &&&&&&&$&&&&@&!&&&&&&&&&&&&#&*&#&&@>*&&&@
&&&!*&#+&&&&&!&<@&?&&&&?&&@&&/&#@&&&#&<&@&&&&@
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
   Prostrate yourself before the Almighty
EOF
}

beginMsg() {
    cat << EOF
          Now, let's cast your lots.
_.--._._._.--._..-.-.___.--._.__..__._._._.-..
^^+~*^^**^*~*^*^*~^*^*^*^*~^*~*^+^+^^^+^^+^^+^
EOF
}

errorMsg() {
    cat << EOF
_.-^-.__._.-..-.__.__._.-^-.__.-.._..-..__.-._
^^+~*^^**^*~*^*^*~^*^*^*^*~^*~*^+^+^^^+^^+^^+^
   You may Ctrl-c yourself out at any time.
_.--._._._.--._..-.-.___.--._.__..__._._._.-..
EOF
}

PROMPTMSG="
_.-^-.__._.-..-.__.__._.-^-.__.-.._..-..__.-._
+^+=^=+^+=+^+^+^==^+^+^+=+^+=^+^+=^=+^+=+^+^+^
       What have you? Numbers? Words?
;,:.,:;,.,.:;.,.;:..,;.,:.;..;.,.;:..,;.,:.;..
>> "

CONTINUEMSG="
' .  '' . '\".  ' \" '. '   \" . '  . '. \" '.  '
Any key to continue.
_.--._._._.--._..-.-.___.--._.__..__._._._.-..
"

# MAIN
printFortune $1

